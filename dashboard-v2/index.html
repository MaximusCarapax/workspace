<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Control v2</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              dark: '#1a1a2e',
              medium: '#16213e', 
              light: '#0f3460',
            },
            accent: '#4da8ff',
            text: {
              primary: '#eee',
              secondary: '#aaa',
              muted: '#888'
            }
          }
        },
      }
    }
  </script>
</head>
<body class="bg-primary-dark text-white">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_BASE = 'http://localhost:3003';
    
    // Overview Tab Component
    const OverviewTab = () => {
      const [health, setHealth] = useState([]);
      const [costs, setCosts] = useState(null);
      const [tasks, setTasks] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchData = async () => {
          try {
            const [healthRes, costsRes, tasksRes] = await Promise.all([
              fetch(`${API_BASE}/api/health`),
              fetch(`${API_BASE}/api/costs`),
              fetch(`${API_BASE}/api/tasks`)
            ]);
            
            setHealth(await healthRes.json());
            setCosts(await costsRes.json());
            setTasks(await tasksRes.json());
          } catch (err) {
            console.error('Error fetching data:', err);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
        const interval = setInterval(fetchData, 60000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return <div className="p-8 text-center">Loading...</div>;
      }

      const getStatusClasses = (status) => {
        switch (status) {
          case 'ok': return 'bg-green-900/20 text-green-400';
          case 'degraded': return 'bg-yellow-900/20 text-yellow-400';
          case 'error': return 'bg-red-900/20 text-red-400';
          default: return 'bg-gray-900/20 text-gray-400';
        }
      };

      const getDotClasses = (status) => {
        switch (status) {
          case 'ok': return 'bg-green-400';
          case 'degraded': return 'bg-yellow-400';
          case 'error': return 'bg-red-400';
          default: return 'bg-gray-400';
        }
      };

      return (
        <div className="space-y-6">
          {/* Cards Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* System Health */}
            <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-primary-light">
              <h3 className="text-xl font-semibold mb-4">System Health</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {health.map((item, index) => (
                  <div key={index} className={`p-3 rounded-lg flex items-center gap-3 ${getStatusClasses(item.status)}`}>
                    <div className={`w-3 h-3 rounded-full ${getDotClasses(item.status)}`}></div>
                    <span className="font-medium">{item.integration}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Costs */}
            <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-primary-light">
              <h3 className="text-xl font-semibold mb-4">Costs (Today)</h3>
              <div className="text-4xl font-bold text-accent mb-4">
                ${costs?.today?.total_cost?.toFixed(2) || '0.00'}
              </div>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {costs?.byModel?.slice(0, 5).map((model, index) => (
                  <div key={index} className="flex justify-between text-sm">
                    <span>{model.model || 'unknown'}</span>
                    <span className="text-text-secondary">${(model.total_cost || 0).toFixed(4)}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Tasks */}
          <div className="space-y-4">
            {/* Current Task */}
            <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-primary-light">
              <h3 className="text-xl font-semibold mb-4">Current Task</h3>
              <div className="bg-blue-900/20 p-4 rounded-lg">
                {tasks?.current ? (
                  <span className="text-lg">üîÑ <strong>{tasks.current.title}</strong></span>
                ) : (
                  <span className="text-text-muted italic">No task in progress</span>
                )}
              </div>
            </div>

            {/* Recently Completed */}
            <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-primary-light">
              <h3 className="text-xl font-semibold mb-4">Recently Completed</h3>
              <div className="space-y-3">
                {tasks?.recent?.length ? tasks.recent.map((task, index) => (
                  <div key={index} className="flex items-center gap-3 py-2 border-b border-primary-light/30 last:border-b-0">
                    <span className="text-green-400">‚úÖ</span>
                    <span>{task.title}</span>
                  </div>
                )) : (
                  <span className="text-text-muted italic">No completed tasks</span>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Journals Tab Component  
    const JournalsTab = () => {
      const [journals, setJournals] = useState([]);
      const [selectedDate, setSelectedDate] = useState(null);
      const [journalContent, setJournalContent] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchJournals = async () => {
          try {
            const res = await fetch(`${API_BASE}/api/journals`);
            const data = await res.json();
            setJournals(data);
          } catch (err) {
            console.error('Error fetching journals:', err);
          } finally {
            setLoading(false);
          }
        };

        fetchJournals();
      }, []);

      const loadJournal = async (date) => {
        setSelectedDate(date);
        setJournalContent('Loading...');
        try {
          const res = await fetch(`${API_BASE}/api/journals/${date}`);
          const text = await res.text();
          setJournalContent(text);
        } catch (err) {
          setJournalContent('Error loading journal');
        }
      };

      if (loading) {
        return <div className="p-8 text-center">Loading...</div>;
      }

      return (
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-200px)]">
          {/* Journal List */}
          <div className="bg-primary-medium rounded-lg p-4 overflow-y-auto">
            <h3 className="text-lg font-semibold mb-4 text-accent">üìù Daily Logs</h3>
            <div className="space-y-2">
              {journals.map((journal, index) => (
                <div
                  key={index}
                  onClick={() => loadJournal(journal.date)}
                  className={`p-3 rounded-lg cursor-pointer transition-colors text-sm ${
                    selectedDate === journal.date 
                      ? 'bg-primary-light text-accent' 
                      : 'hover:bg-primary-light/50'
                  }`}
                >
                  {journal.date}
                </div>
              ))}
            </div>
          </div>

          {/* Journal Content */}
          <div className="lg:col-span-3 bg-primary-medium rounded-lg p-6 overflow-y-auto">
            {selectedDate ? (
              <div>
                <h2 className="text-2xl font-semibold text-accent mb-4">{selectedDate}</h2>
                <div 
                  className="prose prose-invert max-w-none"
                  dangerouslySetInnerHTML={{ 
                    __html: typeof marked !== 'undefined' ? marked.parse(journalContent) : journalContent 
                  }}
                />
              </div>
            ) : (
              <div className="text-center text-text-muted italic">Select a date to view</div>
            )}
          </div>
        </div>
      );
    };

    // Tasks Tab Component
    const TasksTab = () => {
      const [tasks, setTasks] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchTasks = async () => {
          try {
            const res = await fetch(`${API_BASE}/api/tasks`);
            const data = await res.json();
            setTasks(data);
          } catch (err) {
            console.error('Error fetching tasks:', err);
          } finally {
            setLoading(false);
          }
        };

        fetchTasks();
        const interval = setInterval(fetchTasks, 30000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return <div className="p-8 text-center">Loading...</div>;
      }

      return (
        <div className="space-y-6">
          {/* Current Task */}
          <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-accent">
            <h3 className="text-xl font-semibold mb-4">Current Task</h3>
            <div className="bg-blue-900/20 p-6 rounded-lg">
              {tasks?.current ? (
                <div>
                  <span className="text-2xl">üîÑ</span>
                  <h4 className="text-xl font-bold mt-2">{tasks.current.title}</h4>
                  <p className="text-text-secondary mt-2">Status: In Progress</p>
                </div>
              ) : (
                <div className="text-center">
                  <span className="text-4xl">‚ú®</span>
                  <h4 className="text-xl font-bold mt-2">No Active Tasks</h4>
                  <p className="text-text-muted italic">All clear!</p>
                </div>
              )}
            </div>
          </div>

          {/* Recently Completed */}
          <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-green-400">
            <h3 className="text-xl font-semibold mb-4">Recently Completed</h3>
            <div className="space-y-4">
              {tasks?.recent?.length ? tasks.recent.map((task, index) => (
                <div key={index} className="bg-green-900/10 p-4 rounded-lg flex items-center gap-4">
                  <span className="text-2xl">‚úÖ</span>
                  <div>
                    <h4 className="font-medium">{task.title}</h4>
                    <p className="text-sm text-text-secondary">Completed recently</p>
                  </div>
                </div>
              )) : (
                <div className="text-center text-text-muted italic py-8">
                  No completed tasks yet
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Activity Tab Component
    const ActivityTab = () => {
      const [activities, setActivities] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchActivity = async () => {
          try {
            const res = await fetch(`${API_BASE}/api/activity`);
            const data = await res.json();
            setActivities(data || []);
          } catch (err) {
            console.error('Error fetching activity:', err);
            setActivities([]);
          } finally {
            setLoading(false);
          }
        };

        fetchActivity();
        const interval = setInterval(fetchActivity, 30000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return <div className="p-8 text-center">Loading...</div>;
      }

      return (
        <div className="space-y-4">
          <div className="bg-primary-medium rounded-lg p-6 border-l-4 border-purple-400">
            <h3 className="text-xl font-semibold mb-4">Recent Activity</h3>
            
            <div className="space-y-3 max-h-96 overflow-y-auto">
              {activities.length ? activities.map((activity, index) => (
                <div key={index} className="bg-primary-dark/50 p-4 rounded-lg border border-primary-light/20">
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h4 className="font-medium text-purple-300">{activity.action || 'Activity'}</h4>
                      <p className="text-sm text-text-secondary mt-1">
                        {activity.details || activity.description || 'No details available'}
                      </p>
                    </div>
                    <span className="text-xs text-text-muted ml-4">
                      {new Date(activity.timestamp || activity.created_at).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              )) : (
                <div className="text-center text-text-muted italic py-8">
                  No recent activity
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };
    
    // Main App Component
    const App = () => {
      const [activeTab, setActiveTab] = useState('Overview');
      
      const tabs = ['Overview', 'Journals', 'Tasks', 'Activity'];
      
      const renderTabContent = () => {
        switch (activeTab) {
          case 'Overview': return <OverviewTab />;
          case 'Journals': return <JournalsTab />;
          case 'Tasks': return <TasksTab />;
          case 'Activity': return <ActivityTab />;
          default: return <OverviewTab />;
        }
      };

      return (
        <div className="min-h-screen bg-primary-dark text-white">
          {/* Header */}
          <header className="bg-primary-dark border-b border-primary-medium/30">
            <div className="container mx-auto px-4 py-6">
              <div className="flex flex-col md:flex-row md:items-center justify-between">
                <div className="flex items-center space-x-3 mb-4 md:mb-0">
                  <div className="w-10 h-10 bg-accent rounded-lg flex items-center justify-center">
                    <span className="text-xl">üéõÔ∏è</span>
                  </div>
                  <h1 className="text-2xl md:text-3xl font-bold">Mission Control</h1>
                  <span className="text-sm bg-accent/20 px-2 py-1 rounded text-accent">v2.0</span>
                </div>
                
                <div className="flex items-center space-x-4">
                  <div className="hidden md:block text-gray-300">
                    Status: <span className="text-accent font-medium">Operational</span>
                  </div>
                  <button 
                    onClick={() => window.location.reload()}
                    className="px-4 py-2 bg-accent hover:bg-accent/90 rounded-lg font-medium transition-colors"
                  >
                    Refresh
                  </button>
                </div>
              </div>
            </div>
          </header>

          {/* Navigation Tabs */}
          <nav className="bg-primary-dark border-b border-primary-medium/30">
            <div className="container mx-auto px-4">
              <div className="flex space-x-1 overflow-x-auto">
                {tabs.map((tab) => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`px-6 py-3 font-medium transition-colors whitespace-nowrap ${
                      activeTab === tab
                        ? 'text-accent border-b-2 border-accent bg-primary-medium/10'
                        : 'text-gray-400 hover:text-gray-300 hover:bg-primary-medium/5'
                    }`}
                  >
                    {tab}
                  </button>
                ))}
              </div>
            </div>
          </nav>

          {/* Main Content */}
          <main className="container mx-auto px-4 py-8">
            {renderTabContent()}
          </main>

          {/* Footer */}
          <footer className="mt-auto border-t border-primary-medium/30 py-6">
            <div className="container mx-auto px-4 text-center text-gray-400">
              <p>Mission Control Dashboard v2.0 ‚Ä¢ Built with Vite + React + Tailwind CSS</p>
              <p className="text-sm mt-1">Last updated: {new Date().toLocaleTimeString()}</p>
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>