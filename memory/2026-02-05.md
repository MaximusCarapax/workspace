
## Sub-Agent Context System Built (00:24 UTC)

**Problem:** Sub-agents were hitting 200k token ceiling. One failed with 190k input + 34k max_tokens > 200k limit.

**Solution:** Lean, role-based context injection system.

**What we built:**
- `subagents/personas/` — Role personas (dev, qa, researcher, writer, spec) ~200 tokens each
- `subagents/guidelines.md` — Shared rules (delegation, db access)
- `subagents/context-builder.js` — Assembles lean prompts
- `tools/spawn.js` — CLI to spawn role-based sub-agents

**Result:** 190k → ~2k tokens (99% reduction)

**Bugs fixed:**
- Circular dependency in embeddings.js (lazy import)
- Missing default model in searchMemoryByEmbedding
- Threshold too strict (0.7 → 0.4)

**Key insight:** Sub-agents are like junior employees — give them the task and a reference manual, not your entire brain dump.

**Design decision:** I did this myself (not delegated) because it was 80% design/20% typing, and foundational infrastructure that affects all future sub-agents.
