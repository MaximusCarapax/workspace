# 2026-02-05

## Major Infrastructure Work — Dev Pipeline V2

### Unified Activity Logging
- Added `source` column: main, subagent, cron, heartbeat
- Added `related_id` column: links to pipeline:X, task:X, etc.
- All activity now traceable by origin and linked item

### Pipeline Kanban System (Full Rewrite)
**New stages:**
```
idea → spec → spec-review → building → qa → final-review → done → live
```

**New features:**
- `parent_id` for linking incidents to parent features
- `health_check` field for future monitoring
- `notes` column (simple text, prepends latest first)
- Notes auto-log to activity with `related_id`

**CLI commands:**
```bash
pipeline board              # Kanban view with all stages
pipeline move <id> <stage>  # Move + auto-logs to activity
pipeline note <id> "text"   # Prepends to notes + logs to activity
pipeline show <id>          # Shows full item with notes
pipeline create --parent X  # Create linked child item
```

### Sub-agent Guidelines Updated
- All personas now reference pipeline workflow
- Required: check pipeline board before starting
- Required: move items through stages
- Required: add notes during work
- All work should have `--related pipeline:X` in activity logs

### Invoice Extraction Pipeline (#25)
- Spec written: `specs/invoice-extraction-pipeline.md`
- Approach: PDF → split pages → vision AI per page → combine
- Fixes timeout issues with large PDFs (45MB total)
- Builder spawned, tool created: `tools/invoice-extractor.js`
- **Issue:** Builder didn't follow pipeline workflow (no notes, didn't move stages)

### Pipeline V2.1 (#38)
- Added `live` stage for production features
- Added `parent_id` for relational links
- Builder followed workflow better (added completion note, moved to review)

## Key Learnings

### Sub-agent Discipline Problem
- Builders don't reliably add notes or follow pipeline workflow
- Even with explicit instructions, invoice builder ignored them
- Pipeline V2.1 builder was better — more explicit "REQUIRED" language helped

### Notes Architecture Decision
- Moved from separate `pipeline_notes` table to simple `notes` column
- Prepends new notes with timestamp: "2026-02-05 08:22 [source] content"
- Also logs to activity for audit trail
- Simpler model, both places stay in sync

### Sub-agent Time Awareness
- Sub-agents have NO awareness of time passing
- Can't do "checkpoint every 2-3 minutes" — they don't experience time
- OpenClaw tracks runtime externally, agent is blind to it

### Enforcement Gaps Identified
- QA can say "FAIL" but nothing enforces it
- Items can move to done even if QA failed
- Need: `qa_passed` flag + check before allowing progression

## Open Items / Next Steps
1. Auto-notes when tools are used (instrument aider, etc.)
2. QA enforcement gating (flag + blocked progression)
3. Test full pipeline workflow with proper spec agent
4. Move #38 through final-review → done → live

## Files Created/Modified
- `specs/dev-pipeline-v2.md` — Full pipeline spec
- `specs/pipeline-v2.1-schema.md` — Live stage + links
- `specs/invoice-extraction-pipeline.md` — Invoice extractor spec
- `tools/invoice-extractor.js` — PDF → vision AI extractor
- `subagents/guidelines.md` — Updated with pipeline workflow
- `subagents/personas/*.md` — All updated with pipeline integration
- `lib/db.js` — Schema migrations, activity integration
- `tools/db.js` — Pipeline CLI commands

## Costs
- Multiple builder spawns (Sonnet)
- Vision AI testing (Gemini, hit rate limits on large files)
- Total day spend: ~$60 (check `db.js costs today`)
