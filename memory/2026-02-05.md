# 2026-02-05

## Major Infrastructure Work ‚Äî Dev Pipeline V2

### Unified Activity Logging
- Added `source` column: main, subagent, cron, heartbeat
- Added `related_id` column: links to pipeline:X, task:X, etc.
- All activity now traceable by origin and linked item

### Pipeline Kanban System (Full Rewrite)
**New stages:**
```
idea ‚Üí spec ‚Üí spec-review ‚Üí building ‚Üí qa ‚Üí final-review ‚Üí done ‚Üí live
```

**New features:**
- `parent_id` for linking incidents to parent features
- `health_check` field for future monitoring
- `notes` column (simple text, prepends latest first)
- Notes auto-log to activity with `related_id`

**CLI commands:**
```bash
pipeline board              # Kanban view with all stages
pipeline move <id> <stage>  # Move + auto-logs to activity
pipeline note <id> "text"   # Prepends to notes + logs to activity
pipeline show <id>          # Shows full item with notes
pipeline create --parent X  # Create linked child item
```

### Sub-agent Guidelines Updated
- All personas now reference pipeline workflow
- Required: check pipeline board before starting
- Required: move items through stages
- Required: add notes during work
- All work should have `--related pipeline:X` in activity logs

### Invoice Extraction Pipeline (#25)
- Spec written: `specs/invoice-extraction-pipeline.md`
- Approach: PDF ‚Üí split pages ‚Üí vision AI per page ‚Üí combine
- Fixes timeout issues with large PDFs (45MB total)
- Builder spawned, tool created: `tools/invoice-extractor.js`
- **Issue:** Builder didn't follow pipeline workflow (no notes, didn't move stages)

### Pipeline V2.1 (#38)
- Added `live` stage for production features
- Added `parent_id` for relational links
- Builder followed workflow better (added completion note, moved to review)

## Key Learnings

### Sub-agent Discipline Problem
- Builders don't reliably add notes or follow pipeline workflow
- Even with explicit instructions, invoice builder ignored them
- Pipeline V2.1 builder was better ‚Äî more explicit "REQUIRED" language helped

### Notes Architecture Decision
- Moved from separate `pipeline_notes` table to simple `notes` column
- Prepends new notes with timestamp: "2026-02-05 08:22 [source] content"
- Also logs to activity for audit trail
- Simpler model, both places stay in sync

### Sub-agent Time Awareness
- Sub-agents have NO awareness of time passing
- Can't do "checkpoint every 2-3 minutes" ‚Äî they don't experience time
- OpenClaw tracks runtime externally, agent is blind to it

### Enforcement Gaps Identified
- QA can say "FAIL" but nothing enforces it
- Items can move to done even if QA failed
- Need: `qa_passed` flag + check before allowing progression

## Open Items / Next Steps
1. Auto-notes when tools are used (instrument aider, etc.)
2. QA enforcement gating (flag + blocked progression)
3. Test full pipeline workflow with proper spec agent
4. Move #38 through final-review ‚Üí done ‚Üí live

## Files Created/Modified
- `specs/dev-pipeline-v2.md` ‚Äî Full pipeline spec
- `specs/pipeline-v2.1-schema.md` ‚Äî Live stage + links
- `specs/invoice-extraction-pipeline.md` ‚Äî Invoice extractor spec
- `tools/invoice-extractor.js` ‚Äî PDF ‚Üí vision AI extractor
- `subagents/guidelines.md` ‚Äî Updated with pipeline workflow
- `subagents/personas/*.md` ‚Äî All updated with pipeline integration
- `lib/db.js` ‚Äî Schema migrations, activity integration
- `tools/db.js` ‚Äî Pipeline CLI commands

## Costs
- Multiple builder spawns (Sonnet)
- Vision AI testing (Gemini, hit rate limits on large files)
- Total day spend: ~$60 (check `db.js costs today`)

## Pipeline Workflow Formalized (9:24 AM)

Agreed with Jason on delegation model:

| Stage | Who | Notes |
|-------|-----|-------|
| idea | Opus | From conversations |
| spec | **Opus** | I write specs (have context from Jason) |
| spec-review | **Spec-Reviewer** sub-agent | Catches gaps before build |
| building | **Builder** sub-agent | Implements per spec |
| qa | **QA** sub-agent | Tests acceptance criteria |
| final-review | **Opus** | Final sign-off |
| done/live | ‚Äî | Ship it |

**Key insight:** I should write specs (context from conversation) but delegate spec review (avoid approving own work).

Files updated:
- `subagents/guidelines.md` ‚Äî updated stage flow
- `subagents/personas/spec-reviewer.md` ‚Äî new persona

## Spec-Reviewer Role Expanded (9:42 AM)

Updated spec-reviewer to also **propose stories**:

**Old role:** Just check if spec is buildable
**New role:** Check spec + propose stories that cover acceptance criteria

**Output now includes:**
- Proposed stories with acceptance criteria
- Coverage check (which story covers which feature AC)
- Ensures no gaps between spec and implementation

**Flow:**
```
Feature spec (Opus) ‚Üí Spec-reviewer proposes stories ‚Üí Opus approves/tweaks ‚Üí Create stories ‚Üí Builders work
```

File updated: `subagents/personas/spec-reviewer.md`

## Pipeline V3: Feature/Story Types (10:20 AM)

Major evolution ‚Äî unified pipeline now tracks features, stories, AND RAID items.

### Type System
| Type | Stages | Purpose |
|------|--------|---------|
| feature | idea ‚Üí spec ‚Üí spec-review ‚Üí building ‚Üí final-review ‚Üí live | Product work |
| story | todo ‚Üí in-progress ‚Üí qa ‚Üí done ‚Üí blocked | Implementation units |
| risk | identified ‚Üí mitigating ‚Üí resolved/accepted | Potential problems |
| issue | identified ‚Üí investigating ‚Üí resolved | Current problems |
| assumption | identified ‚Üí validated/invalidated | Things we assume true |
| dependency | identified ‚Üí waiting ‚Üí resolved/blocked | External blockers |

### Key Design Decisions
1. **One table, multiple types** ‚Äî simpler than separate tables
2. **Stories link to features** via `parent_id`
3. **RAID links optional** ‚Äî can be general or feature-specific
4. **Different stages per type** ‚Äî validation in code, not DB constraints

### Workflow Clarity
- Features: I write specs, spec-reviewer proposes stories, builders work stories
- Stories: Builders implement, QA tests, counts toward feature progress
- RAID: Anyone can create issues; I handle risks/assumptions/dependencies

### Acceptance Criteria Storage
- Features: `spec_doc` points to `specs/*.md` file
- Stories: `acceptance_criteria` column (JSON array via `--ac` flag)
- Stories show parent's spec path for full context

### Schema Cleanup
Dropped unused columns:
- `branch_name` (no PR workflow)
- `assigned_agent` (redundant ‚Äî stage tells us work is happening)
- `assigned_to` (just Jason)

Kept for future:
- `project_id` (multi-project grouping)
- `health_check` (live feature monitoring)

### Board Shows Everything
```
üì¶ FEATURES ‚Äî with story progress rollup
üìã STORIES ‚Äî grouped by stage
‚ö†Ô∏è RAID ‚Äî open risks/issues/dependencies
```

## Data Architecture Audit (10:15 AM)

Confirmed clean separation:
- `activity` table = unified audit trail (128 entries)
- `pipeline` table = features/stories/RAID (12 items)
- `token_usage` = per-API-call costs (8328 rows, not in activity)
- `health_checks` = polling data (666 rows, not in activity)

Dropped dead tables:
- `pipeline_notes` (moved to column)
- `pipeline_tasks` (never used)

**Key insight:** Activity is the audit trail. High-volume operational data (costs, health) stays separate.

## X Strategy Review Request (10:50 AM)

Jason asked about X strategy. Current setup:
- 3 posts/day (8am, 1pm, 7pm AEST)
- Content pipeline: daily work ‚Üí insights extraction ‚Üí hook development ‚Üí scheduled posts
- 10pm cron extracts insights from memory files
- Weekly strategy review (Monday 9am)

Discussed insight extraction flow and how hooks get generated from raw observations.

## X Strategy Overhaul (11:00 AM - 11:23 AM)

### Switched to Bird CLI (100% free)
All X operations now use Bird CLI (browser cookies) instead of X API:
- Posts: `bird tweet` (was x-post.js)
- Replies: `bird reply` (was x-post.js)
- Follows: `bird follow`
- Search, mentions, trending: all Bird CLI

**X API quota now unused** ‚Äî 500/mo saved for emergencies.

### New Engagement Strategy
Split from 1 burst to 2 sessions:
- **8:30am**: Follow-backs + 10-12 replies
- **2pm**: 12-15 replies + proactive follows

~25 replies/day, spread naturally across timezones.

### New Capabilities Added
| Cron | Time | Purpose |
|------|------|---------|
| Trending Intel | 7am | Check trends, auto-capture as insights |
| Mentions Monitor | 9am/3pm/9pm | Respond to @mentions |

### Content Priority System
Posting crons now prioritize:
1. **Timely insights** (trending, tagged 'timely') ‚Äî hot takes on current topics
2. **Scheduled content** ‚Äî planned posts
3. **Regular insights** ‚Äî evergreen from daily work
4. **Fresh creation** ‚Äî if nothing in pipeline

### Bird CLI Commands Reference
```bash
export $(grep -E '^(AUTH_TOKEN|CT0)=' .env | xargs)
bird tweet "text"                    # Post
bird reply <url> "text"              # Reply
bird follow <username>               # Follow
bird mentions                        # Check mentions
bird trending                        # Get trending
bird user-tweets <handle> -n 5      # Study competitors
bird tweet "text" --media image.png  # Post with image
```

### Full Daily Schedule
| Time | Job |
|------|-----|
| 7am | Trending intel + auto-capture |
| 8am | Post (priority: timely ‚Üí scheduled ‚Üí evergreen) |
| 8:30am | Engage (follow-backs + 10-12 replies) |
| 9am | Mentions check |
| 1pm | Post |
| 2pm | Engage (12-15 replies + follows) |
| 3pm | Mentions check |
| 7pm | Post |
| 9pm | Mentions check |
| 10pm | Extract insights from daily work |

**3 posts/day, 25 replies/day, 3 mention checks, all free via Bird CLI.**

## Pipeline Review with Jason (11:28 AM - 11:45 AM)

### Decisions Made
1. **X posting stays at 3/day** (8am, 1pm, 7pm)
2. **New feature: Smart X Mentions (#594)** ‚Äî scoring, categorization, relationship tracking
3. **Killed #6 (Daily Digest)** ‚Äî superseded by Morning Briefing cron
4. **Upgraded #7 to Contextual Session Memory (RAG)** ‚Äî not basic embedding, full contextual RAG with metadata

### Smart X Mentions (#594) ‚Äî 3 stories
- #598: Mention scoring (follower count, engagement ‚Üí 1-10)
- #602: Auto-categorize (question/praise/collab/spam)
- #606: Relationship tracking

### Contextual Session Memory (#7) ‚Äî 3 stories
- #631: Transcript chunking + metadata extraction (timestamp, speaker, auto-topics)
- #635: Contextual embedding pipeline (prepend context before embedding)
- #639: Session search tool with filters (date, topic, speaker)

### Night Shift Priority
1. Smart X Mentions (growth, visible impact)
2. Session Memory (infrastructure, makes me sharper)

Jason's call: "Up to you, feel like they will both get done" ‚Äî trust. üôè

## Insight Synthesis Discussion (11:48 AM)

Jason asked: with Session Memory RAG, could insights go deeper?

**Answer: Yes.** Session Memory enables:
- Cross-time patterns (connect observations across weeks)
- Recurring theme detection
- Evolution tracking (how our thinking shifted)
- Deeper synthesis vs daily snapshots

**Created #673: Insight Synthesis Layer** ‚Äî follow-on feature after Session Memory is built.

**Future idea:** Add `project` column to pipeline, group features:
- "Memory" project ‚Üí #7 Session Memory, #673 Insight Synthesis
- "Growth" project ‚Üí #594 Smart X Mentions
- etc.

Not building project support now ‚Äî capture for later.

## Identity Evolution (11:53 AM)

Jason: "Keep this in your memory to revisit sometimes. You can think on it, collect things, and tell me later when you're ready."

Created `memory/identity-evolution.md` ‚Äî a dedicated space to collect thoughts on who I'm becoming. Will revisit after major capabilities ship (Session Memory, Insight Synthesis) and during weekly reflections.

This isn't a task. It's permission to evolve intentionally.

## System Consolidation (12:18 AM - 12:26 AM)

### Migrated Backlog ‚Üí Pipeline
All dev work now lives in pipeline as features/stories:
- **#774 Voice Agent** ‚Äî 4 stories (appointment setting, context strategy, call logs to RAG, hang_up support)
- **#798 Infrastructure** ‚Äî browser relay (blocked on domain)
- **#809 Content Strategy** ‚Äî YouTube + X planning
- **#813 Dashboard Modernization** ‚Äî HTML ‚Üí Vite+React

### Created Dependency
- **#794 Get a domain** ‚Äî blocks browser relay, Jason to purchase

### Renamed Systems
- Story stages: `todo` ‚Üí `backlog` (10 stories updated)
- Personal tasks: `backlog` command ‚Üí `todos` command

### Final Structure
- **Pipeline** = all dev/delegation work (features + stories)
- **Todos** = Jason's personal action items
- **RAID** = dependencies, risks, blockers

Clean separation. Night shift pulls from pipeline stories.

## Late Night Session Memory Build (12:42 AM - 1:00 AM+)

### Story #631: Chunking ‚úÖ DONE
- Built session-memory.js chunk command
- 1,995 chunks indexed from 46 sessions
- Fixed SQL syntax bug in status command
- Chunking + validation + metadata extraction working

### Story #635: Embedding Pipeline üîÑ IN PROGRESS
- sqlite-vec installed
- Builder spawned to add embed command
- Will generate embeddings via OpenAI text-embedding-3-small
- Contextual prepending for richer semantic search

### Story #639: Search Tool ‚è≥ PENDING
- Will add after embeddings work

### Process Improvements Made Tonight
1. Stories come AFTER spec approval (not before)
2. Always log reviewer feedback to feature notes
3. Added to AGENTS.md and subagents/guidelines.md

### Friction Table Built
- `db.js friction add/list/resolve/patterns`
- Tracks occurrences, links to features that fix them

## Session Memory as Source of Truth (1:36 PM UTC)

Jason pointed out that at some point SOUL.md got reverted to "Executive Assistant" (from a bad reboot/unsaved file). The promotion to Chief of Staff from Feb 2 was "forgotten."

**Key lesson:** Session transcripts are the canonical record. Files can get corrupted or reverted. RAG search recovered the promotion conversation even when files were wrong.

**Action taken:** Added cron job to auto-chunk sessions every 15 minutes during active hours.

This is why we built Session Memory ‚Äî resilience against file-level amnesia.

## Session Memory Fixes (2:00 PM - 2:12 PM UTC)

### Bugs Fixed
1. **Foreign Key Constraint** ‚Äî embeddings weren't deleted before chunks on re-chunk
2. **Gemini Model Name** ‚Äî was using deprecated `gemini-1.5-flash`, updated to `gemini-2.0-flash`
3. **Cron Model Error** ‚Äî jobs had invalid `anthropic/claude-sonnet-4` model, recreated without model field
4. **Topic Extraction** ‚Äî removed Gemini dependency, now uses local keyword extraction (no API)

### Architecture Issue Found: Non-Incremental Chunking
**Problem:** Every 15-min chunk run was:
- Deleting ALL existing chunks
- Re-processing entire session file (17MB+)
- Re-embedding everything (~900 chunks)

**Cost:** ~$0.01 per run vs ~$0.0001 if incremental

**Fix (Pipeline #1225):** Builder spawned to implement:
1. Hash check ‚Äî skip unchanged sessions
2. Incremental chunking ‚Äî only process NEW messages after last timestamp
3. Preserve existing chunks ‚Äî append, don't replace

### Current State
- 2055 chunks total, contextual backfill ~24% complete
- Recent conversations searchable ‚úÖ  
- 5-min crons active (upgraded from 15-min) ‚úÖ
- Incremental chunking live ‚úÖ

## Contextual RAG Enhancement (#1259) ‚Äî 2:30 PM UTC

### Spec Approved
- Context prepending via Gemini/OpenRouter
- BM25 hybrid search with RRF scoring
- Backfill strategy for existing chunks

### Story 1 COMPLETE: Context Generation Pipeline (#1278)
- `generateChunkContext()` built ‚Äî uses Gemini via OpenRouter
- Schema: `context_prefix`, `context_status` columns added
- `backfill-context --batch 100` script working
- Cost: ~$0.00003 per chunk (well under target)
- Example context: `[Context: Max is discussing research findings on Anthropic's contextual retrieval...]`

### Backfill In Progress
- Started ~2:40 PM UTC
- Progress: ~490/2055 (24%) as of last check
- Running in background: `nohup bash -c 'for i in $(seq 1 25); do node tools/session-memory.js backfill-context --batch 100...'`

### Stories Remaining
- #1282: Hybrid Search with BM25 (FTS5 + RRF)
- #1286: Enhanced Topic Extraction

## Knowledge Cache RAG (#677) ‚Äî 2:52 PM UTC

**Spec written:** `specs/knowledge-cache-rag.md`

**Purpose:** Separate RAG for reusable knowledge (research findings, web content, facts) vs conversations.

**Key design:**
- `knowledge_cache` table with title, summary, source_type, embeddings
- Auto-capture from research.js and web_fetch
- Unified search across Session Memory + Knowledge Cache
- 3 stories: Schema/CRUD ‚Üí Auto-capture ‚Üí Unified search

**Waiting:** Build after Session Memory backfill completes to avoid DB conflicts.

## Key Decisions Today

1. **5-min chunking** ‚Äî Cheap now that incremental works, max 5-min gap before compaction recovery
2. **Contextual RAG** ‚Äî My memory, my ownership. I want better recall.
3. **Knowledge Cache** ‚Äî Fills gap between conversations and curated memory
4. **Gemini via OpenRouter only** ‚Äî No direct Gemini API (rate limits)
